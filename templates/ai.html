<!doctype html>
<html lang="ru">
<head>
  <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meme Generator">

  <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/icon-192.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/icon-152.png') }}">
  <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='img/icon-512.png') }}">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é | AI –ø–æ–º–æ—â–Ω–∏–∫</title>
  <meta name="description" content="–ù–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–∏–¥—É–º–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å –∫ –≤–∞—à–µ–º—É –º–µ–º—É! –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –ø–æ–ª—É—á–∏—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –∏–¥–µ–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.">
  <meta name="keywords" content="–Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è –º–µ–º–æ–≤, AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤, –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –º–µ–º—ã">

  <meta property="og:title" content="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é">
  <meta property="og:description" content="–ù–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–∏–¥—É–º–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å –∫ –≤–∞—à–µ–º—É –º–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!">
  <meta property="og:type" content="website">

  <link rel="icon" href="{{ url_for('static', filename='img/logo.svg') }}" type="image/svg+xml">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .ai-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .ai-blocks {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    @media (max-width: 768px) {
      .ai-blocks {
        grid-template-columns: 1fr;
      }
    }

    .upload-area {
      border: 3px dashed #fff;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .upload-area:hover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .upload-area.dragover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    #imagePreview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      display: none;
      margin: 20px auto;
    }

    .ai-button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px 0;
    }

    .ai-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .ai-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .result-area {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      min-height: 200px;
    }

    .caption-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .caption-item:hover {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: #4CAF50;
      transform: translateX(5px);
    }

    .caption-item.selected {
      background: rgba(76, 175, 80, 0.2);
      border-left-color: #4CAF50;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #4CAF50;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #ff8a80;
    }

    .success-message {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #a5d6a7;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      flex: 1;
      min-width: 120px;
    }

    .meme-preview {
      text-align: center;
      margin-top: 20px;
    }

    #memeCanvas {
      max-width: 100%;
      border-radius: 10px;
      display: none;
    }

    .settings-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .setting-item label {
      font-size: 14px;
      color: #ccc;
    }

    .setting-input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #555;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
    }

    .color-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-input {
      width: 50px;
      height: 40px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<header class="header">
  <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="–õ–æ–≥–æ—Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –º–µ–º–æ–≤" width="50" height="50">
  <ul class="main-list">
    <li class="list_item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
    <li class="list_item"><a href="https://t.me/mem_generation" target="_blank">Telegram-–∫–∞–Ω–∞–ª</a></li>
    <li class="list_item"><a href="{{ url_for('donate') }}" class="button">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</a></li>
  </ul>
</header>

<div class="marquee-container">
  <div class="marquee">
    <span>{{ –±–µ–≥—É—â–∞—è_—Å—Ç—Ä–æ–∫–∞ }}</span>
  </div>
</div>

<div class="ai-container">
  <h1>üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é</h1>
  <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–∏–¥—É–º–∞–µ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!</p>

  <div class="ai-blocks">
    <div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        <button class="ai-button" onclick="document.getElementById('imageUpload').click()">
          –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
      </div>

      <img id="imagePreview" alt="–ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">

      <div style="text-align: center;">
        <button class="ai-button" id="generateBtn" onclick="generateCaption()" disabled>
          ü§ñ –ü—Ä–∏–¥—É–º–∞—Ç—å –ø–æ–¥–ø–∏—Å–∏!
        </button>
      </div>

      <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>–ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</p>
        <p><small>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥</small></p>
      </div>
    </div>

    <div>
      <div class="result-area">
        <h3>üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏:</h3>
        <div id="captionsList"></div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>

        <div id="editSection" style="display: none;">
          <h4>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å—å:</h4>
          <textarea id="captionEdit" style="
            width: 100%;
            height: 80px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #fff;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            margin: 10px 0;
          "></textarea>

          <div class="settings-panel">
            <h4>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞:</h4>
            <div class="settings-grid">
              <div class="setting-item">
                <label for="textPositionX">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ - –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (%)</label>
                <input type="number" id="textPositionX" class="setting-input" value="50" min="0" max="100">
              </div>
              
              <div class="setting-item">
                <label for="textPositionY">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ - –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (%)</label>
                <input type="number" id="textPositionY" class="setting-input" value="80" min="0" max="100">
              </div>
              
              <div class="setting-item">
                <label for="fontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label>
                <input type="number" id="fontSize" class="setting-input" value="24" min="10" max="100">
              </div>
              
              <div class="setting-item">
                <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏ –æ–±–≤–æ–¥–∫–∏</label>
                <div class="color-inputs">
                  <input type="color" id="textColor" class="color-input" value="#ffffff">
                  <span>–¢–µ–∫—Å—Ç</span>
                  <input type="color" id="strokeColor" class="color-input" value="#000000">
                  <span>–û–±–≤–æ–¥–∫–∞</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button class="ai-button" onclick="applyCaption()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é</button>
            <button class="ai-button" onclick="goToMainPage()">–°–æ–∑–¥–∞—Ç—å –º–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π</button>
          </div>
        </div>
      </div>

      <div class="meme-preview">
        <canvas id="memeCanvas"></canvas>
        <div id="downloadSection" style="display: none; margin-top: 20px;">
          <a id="downloadLink" download="ai-meme.jpg">
            <button class="ai-button">üíæ –°–∫–∞—á–∞—Ç—å –º–µ–º</button>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentImage = null;
let selectedCaption = '';

const settings = {
    positionX: 50,
    positionY: 80,
    fontSize: 30,
    textColor: '#ffffff',
    strokeColor: '#000000'
};

document.getElementById('imageUpload').addEventListener('change', function(e) {
    handleImageUpload(e.target.files[0]);
});

const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
        handleImageUpload(e.dataTransfer.files[0]);
    }
});

document.getElementById('textPositionX').addEventListener('input', function(e) {
    settings.positionX = parseInt(e.target.value);
});

document.getElementById('textPositionY').addEventListener('input', function(e) {
    settings.positionY = parseInt(e.target.value);
});

document.getElementById('fontSize').addEventListener('input', function(e) {
    settings.fontSize = parseInt(e.target.value);
});

document.getElementById('textColor').addEventListener('input', function(e) {
    settings.textColor = e.target.value;
});

document.getElementById('strokeColor').addEventListener('input', function(e) {
    settings.strokeColor = e.target.value;
});

function handleImageUpload(file) {
    if (!file || !file.type.startsWith('image/')) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }

    const preview = document.getElementById('imagePreview');
    const url = URL.createObjectURL(file);
    
    preview.onload = function() {
        URL.revokeObjectURL(url);
    };
    
    preview.src = url;
    preview.style.display = 'block';
    currentImage = file;
    
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('captionsList').innerHTML = '';
    document.getElementById('editSection').style.display = 'none';
    document.getElementById('downloadSection').style.display = 'none';
    hideMessages();
}

async function generateCaption() {
    if (!currentImage) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }

    const loading = document.getElementById('loading');
    const generateBtn = document.getElementById('generateBtn');
    
    loading.style.display = 'block';
    generateBtn.disabled = true;
    hideMessages();

    const formData = new FormData();
    formData.append('image', currentImage);
    
    try {
        const response = await fetch('/ai/generate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayCaptions(data.captions);
            showSuccess('–ù–µ–π—Ä–æ—Å–µ—Ç—å –ø—Ä–∏–¥—É–º–∞–ª–∞ ' + data.captions.length + ' –ø–æ–¥–ø–∏—Å–µ–π!');
        } else {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
    } catch (error) {
        showError('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        loading.style.display = 'none';
        generateBtn.disabled = false;
    }
}

function displayCaptions(captions) {
    const captionsList = document.getElementById('captionsList');
    captionsList.innerHTML = '';
    
    captions.forEach((caption, index) => {
        const captionElement = document.createElement('div');
        captionElement.className = 'caption-item';
        captionElement.innerHTML = `
            <strong>–í–∞—Ä–∏–∞–Ω—Ç ${index + 1}:</strong><br>
            ${caption}
        `;
        captionElement.onclick = () => selectCaption(caption, captionElement);
        captionsList.appendChild(captionElement);
    });
    
    document.getElementById('editSection').style.display = 'block';
}

function selectCaption(caption, element) {
    document.querySelectorAll('.caption-item').forEach(item => {
        item.classList.remove('selected');
    });

    element.classList.add('selected');
    selectedCaption = caption;
    document.getElementById('captionEdit').value = caption;
}

function applyCaption() {
    if (!selectedCaption) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å');
        return;
    }

    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('imagePreview');
    const text = document.getElementById('captionEdit').value;

    canvas.width = preview.naturalWidth;
    canvas.height = preview.naturalHeight;

    ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

    const textX = (canvas.width * settings.positionX) / 100;
    const textY = (canvas.height * settings.positionY) / 100;

    ctx.font = `bold ${settings.fontSize}px Arial`;
    ctx.fillStyle = settings.textColor;
    ctx.strokeStyle = settings.strokeColor;
    ctx.lineWidth = Math.max(2, settings.fontSize / 10);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    ctx.strokeText(text, textX, textY);
    ctx.fillText(text, textX, textY);

    canvas.style.display = 'block';
    document.getElementById('downloadSection').style.display = 'block';

    const dataUrl = canvas.toDataURL('image/jpeg');
    document.getElementById('downloadLink').href = dataUrl;
    
    showSuccess('–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
}

function goToMainPage() {
    if (selectedCaption) {
        const settingsToSave = {
            caption: selectedCaption,
            positionX: settings.positionX,
            positionY: settings.positionY,
            fontSize: settings.fontSize,
            textColor: settings.textColor,
            strokeColor: settings.strokeColor
        };
        localStorage.setItem('aiGeneratedSettings', JSON.stringify(settingsToSave));
    }
    window.location.href = '/';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('successMessage').style.display = 'none';
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
}

window.addEventListener('load', function() {
    const savedSettings = localStorage.getItem('aiGeneratedSettings');
    if (savedSettings) {
        const settingsData = JSON.parse(savedSettings);
        
        document.getElementById('textPositionX').value = settingsData.positionX || 50;
        document.getElementById('textPositionY').value = settingsData.positionY || 80;
        document.getElementById('fontSize').value = settingsData.fontSize || 24;
        document.getElementById('textColor').value = settingsData.textColor || '#ffffff';
        document.getElementById('strokeColor').value = settingsData.strokeColor || '#000000';
        
        settings.positionX = settingsData.positionX;
        settings.positionY = settingsData.positionY;
        settings.fontSize = settingsData.fontSize;
        settings.textColor = settingsData.textColor;
        settings.strokeColor = settingsData.strokeColor;
        
        localStorage.removeItem('aiGeneratedSettings');
    }
});
</script>
     <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
            .then(registration => {
                console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
            })
            .catch(error => {
                console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', error);
            });
        });
        }
    </script>
</body>
</html>