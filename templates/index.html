<!doctype html>
<html lang="ru">
<head>
  <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meme Generator">

  <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/icon-192.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/icon-152.png') }}">
  <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='img/icon-512.png') }}">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ –æ–Ω–ª–∞–π–Ω | –°–æ–∑–¥–∞–π —Å–≤–æ–π –º–µ–º –ª–µ–≥–∫–æ</title>
  <meta name="description" content="–°–æ–∑–¥–∞–π —Å–≤–æ–π –º–µ–º –æ–Ω–ª–∞–π–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ! –£–¥–æ–±–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ç–µ–∫—Å—Ç–∞, —Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç–æ–≤ –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è.">
  <meta name="keywords" content="–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤, —Å–æ–∑–¥–∞—Ç—å –º–µ–º, –º–µ–º –æ–Ω–ª–∞–π–Ω, meme generator, –º–µ–º—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ">

  <meta property="og:title" content="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–º–æ–≤ –æ–Ω–ª–∞–π–Ω">
  <meta property="og:description" content="–°–æ–∑–¥–∞–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ–º—ã –æ–Ω–ª–∞–π–Ω –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –¥–µ–ª–∏—Å—å –∏–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏.">
  <meta property="og:type" content="website">

  <link rel="icon" href="{{ url_for('static', filename='img/logo.svg') }}" type="image/svg+xml">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .meme-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .meme-blocks {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    @media (max-width: 768px) {
      .meme-blocks {
        grid-template-columns: 1fr;
      }
    }

    .upload-area {
      border: 3px dashed #fff;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .upload-area.dragover {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    #imagePreview {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      display: none;
      margin: 20px auto;
      border: 2px solid #fff;
    }

    .meme-button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px 5px;
      color: white;
    }

    .meme-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .meme-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .settings-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .setting-item label {
      font-size: 14px;
      color: #ccc;
    }

    .setting-input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #555;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
    }

    .color-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-input {
      width: 50px;
      height: 40px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .text-inputs {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .text-area {
      width: 100%;
      height: 80px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #555;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 16px;
      resize: vertical;
      font-family: inherit;
    }

    .text-area:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .preview-area {
      text-align: center;
      position: relative;
    }

    #memeCanvas {
      max-width: 100%;
      max-height: 500px;
      border-radius: 10px;
      border: 2px solid #fff;
      display: none;
    }

    .download-section {
      text-align: center;
      margin-top: 20px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .action-buttons button {
      flex: 1;
      min-width: 140px;
    }

    .real-time-preview {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
      display: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —à–∞–±–ª–æ–Ω–æ–≤ */
    .templates-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .templates-modal-content {
      background: #2d2d2d;
      border-radius: 15px;
      padding: 30px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      width: 800px;
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .template-item {
      cursor: pointer;
      border: 2px solid #555;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .template-item:hover {
      border-color: #4CAF50;
      transform: translateY(-5px);
    }

    .template-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .template-name {
      padding: 10px;
      text-align: center;
      font-size: 12px;
      color: #fff;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-button {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .template-button {
      width: 100%;
      margin-bottom: 20px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA –ø–æ–¥ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π */
    .pwa-install-container {
      text-align: center;
      margin: 15px auto;
      max-width: 1200px;
      padding: 0 20px;
    }
    
    .pwa-install-btn {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: none;
      margin: 10px auto;
    }

    .pwa-install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
  </style>
  <meta name="google-site-verification" content="9cgZ2LZmsgqLgMxmD55mnjnse5XryeVesFWeZOg_qPY" />
  <meta name="google-site-verification" content="PUaRKBHKxgGsYHU6ysdWAfV1XLBaa0IQuzRfgkgAuXA" />
</head>
<body>
<header class="header">
  <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="–õ–æ–≥–æ—Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –º–µ–º–æ–≤" width="50" height="50">
  <ul class="main-list">
    <li class="list_item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
    <li class="list_item"><a href="/ai">–ò–ò-–º–µ–º</a></li>
    <li class="list_item"><a href="https://t.me/mem_generation" target="_blank">Telegram-–∫–∞–Ω–∞–ª</a></li>
    <li class="list_item"><a href="{{ url_for('donate') }}" class="button">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</a></li>
  </ul>
</header>

<div class="marquee-container">
  <div class="marquee">
    <span>{{ –±–µ–≥—É—â–∞—è_—Å—Ç—Ä–æ–∫–∞ }}</span>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA (–ø–æ–¥ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π) -->
<div class="pwa-install-container">
  <button id="installButton" class="pwa-install-btn">
    üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  </button>
</div>

<div class="meme-container">
  <h1>üé® –°–æ–∑–¥–∞–π —Å–≤–æ–π –º–µ–º!</h1>
  <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>

  <div class="meme-blocks">
    <div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        <button class="meme-button" onclick="document.getElementById('imageUpload').click()">
          –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤ -->
      <div class="templates-section">
        <button class="meme-button template-button" onclick="loadTemplates()">
          üé≠ –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω
        </button>
      </div>

      <img id="imagePreview" alt="–ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">

      <div class="text-inputs">
        <div class="setting-item">
          <label for="textTop">–¢–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É:</label>
          <textarea id="textTop" class="text-area" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –º–µ–º–∞..."></textarea>
        </div>

        <div class="setting-item">
          <label for="textBottom">–¢–µ–∫—Å—Ç —Å–Ω–∏–∑—É:</label>
          <textarea id="textBottom" class="text-area" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –º–µ–º–∞..."></textarea>
        </div>
      </div>

      <div class="settings-panel">
        <h3>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞:</h3>
        <div class="settings-grid">
          <div class="setting-item">
            <label for="textTopX">–í–µ—Ä—Ö–Ω–∏–π —Ç–µ–∫—Å—Ç - –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (%)</label>
            <input type="number" id="textTopX" class="setting-input" value="50" min="0" max="100">
          </div>
          
          <div class="setting-item">
            <label for="textTopY">–í–µ—Ä—Ö–Ω–∏–π —Ç–µ–∫—Å—Ç - –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (%)</label>
            <input type="number" id="textTopY" class="setting-input" value="20" min="0" max="100">
          </div>
          
          <div class="setting-item">
            <label for="textBottomX">–ù–∏–∂–Ω–∏–π —Ç–µ–∫—Å—Ç - –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (%)</label>
            <input type="number" id="textBottomX" class="setting-input" value="50" min="0" max="100">
          </div>
          
          <div class="setting-item">
            <label for="textBottomY">–ù–∏–∂–Ω–∏–π —Ç–µ–∫—Å—Ç - –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (%)</label>
            <input type="number" id="textBottomY" class="setting-input" value="80" min="0" max="100">
          </div>
          
          <div class="setting-item">
            <label for="fontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label>
            <input type="number" id="fontSize" class="setting-input" value="30" min="10" max="100">
          </div>
          
          <div class="setting-item">
            <label>–¶–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞</label>
            <div class="color-inputs">
              <input type="color" id="textColor" class="color-input" value="#ffffff">
              <span>–¢–µ–∫—Å—Ç</span>
              <input type="color" id="strokeColor" class="color-input" value="#000000">
              <span>–û–±–≤–æ–¥–∫–∞</span>
            </div>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="meme-button" onclick="updateMemePreview()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
        <button class="meme-button" onclick="downloadMeme()">üíæ –°–∫–∞—á–∞—Ç—å –º–µ–º</button>
        <button class="meme-button" onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
      </div>

      <div class="real-time-preview" id="realTimePreview">
        üîÑ –ü—Ä–µ–≤—å—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      </div>
    </div>

    <div class="preview-area">
      <h3>üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–º–∞:</h3>
      <canvas id="memeCanvas"></canvas>
      <div class="download-section" id="downloadSection" style="display: none;">
        <a id="downloadLink" download="my-meme.jpg">
          <button class="meme-button">üì• –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –º–µ–º</button>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤ -->
<div id="templatesModal" class="templates-modal">
  <div class="templates-modal-content">
    <div class="modal-header">
      <h2 style="color: white; margin: 0;">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</h2>
      <button class="close-button" onclick="closeTemplatesModal()">√ó</button>
    </div>
    <div id="templatesGrid" class="templates-grid">
      <!-- –®–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
    </div>
    <div style="text-align: center;">
      <button class="meme-button" onclick="closeTemplatesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
// –°–∫—Ä–∏–ø—Ç –¥–ª—è PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∏
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏
  e.preventDefault();
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–∑–∂–µ
  deferredPrompt = e;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  const installButton = document.getElementById('installButton');
  if (installButton) {
    installButton.style.display = 'inline-block';
    
    installButton.addEventListener('click', async () => {
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
      installButton.style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      deferredPrompt.prompt();
      
      // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏–ª PWA');
      } else {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏');
        // –ú–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
        setTimeout(() => {
          installButton.style.display = 'inline-block';
        }, 3000);
      }
      
      deferredPrompt = null;
    });
  }
});

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
window.addEventListener('appinstalled', (evt) => {
  console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
  const installButton = document.getElementById('installButton');
  if (installButton) {
    installButton.style.display = 'none';
  }
});

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
window.addEventListener('load', () => {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
  
  if (isStandalone) {
    console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    const installButton = document.getElementById('installButton');
    if (installButton) {
      installButton.style.display = 'none';
    }
  }
});

// –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –º–µ–º–æ–≤
const settings = {
    image: null,
    textTop: '',
    textBottom: '',
    textTopX: 50,
    textTopY: 20,
    textBottomX: 50,
    textBottomY: 80,
    fontSize: 30,
    textColor: '#ffffff',
    strokeColor: '#000000'
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–∞–±–ª–æ–Ω–∞–º–∏
async function loadTemplates() {
    try {
        const response = await fetch('/get_templates');
        const templates = await response.json();
        showTemplatesModal(templates);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤');
    }
}

function showTemplatesModal(templates) {
    const modal = document.getElementById('templatesModal');
    const grid = document.getElementById('templatesGrid');
    
    grid.innerHTML = '';
    
    if (templates.length === 0) {
        grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1 / -1;">–®–∞–±–ª–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
    } else {
        templates.forEach(template => {
            const templateItem = document.createElement('div');
            templateItem.className = 'template-item';
            templateItem.innerHTML = `
                <img src="${template.path}" alt="${template.filename}" class="template-image">
                <div class="template-name">${template.filename}</div>
            `;
            templateItem.onclick = () => selectTemplate(template.filename);
            grid.appendChild(templateItem);
        });
    }
    
    modal.style.display = 'flex';
}

function closeTemplatesModal() {
    document.getElementById('templatesModal').style.display = 'none';
}

async function selectTemplate(templateFilename) {
    try {
        const response = await fetch('/select_template', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ template_filename: templateFilename })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –≤ –ø—Ä–µ–≤—å—é
            const preview = document.getElementById('imagePreview');
            preview.src = result.meme_url;
            preview.style.display = 'block';
            settings.image = { name: templateFilename };
            
            closeTemplatesModal();
            showRealTimePreview();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            updateMemePreview();
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞: ' + result.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞:', error);
        alert('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞');
    }
}

// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('imageUpload').addEventListener('change', function(e) {
        handleImageUpload(e.target.files[0]);
    });

    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleImageUpload(e.dataTransfer.files[0]);
        }
    });

    document.getElementById('textTop').addEventListener('input', function(e) {
        settings.textTop = e.target.value;
        debouncedUpdatePreview();
    });

    document.getElementById('textBottom').addEventListener('input', function(e) {
        settings.textBottom = e.target.value;
        debouncedUpdatePreview();
    });

    document.getElementById('textTopX').addEventListener('input', function(e) {
        settings.textTopX = parseInt(e.target.value);
        debouncedUpdatePreview();
    });

    document.getElementById('textTopY').addEventListener('input', function(e) {
        settings.textTopY = parseInt(e.target.value);
        debouncedUpdatePreview();
    });

    document.getElementById('textBottomX').addEventListener('input', function(e) {
        settings.textBottomX = parseInt(e.target.value);
        debouncedUpdatePreview();
    });

    document.getElementById('textBottomY').addEventListener('input', function(e) {
        settings.textBottomY = parseInt(e.target.value);
        debouncedUpdatePreview();
    });

    document.getElementById('fontSize').addEventListener('input', function(e) {
        settings.fontSize = parseInt(e.target.value);
        debouncedUpdatePreview();
    });

    document.getElementById('textColor').addEventListener('input', function(e) {
        settings.textColor = e.target.value;
        debouncedUpdatePreview();
    });

    document.getElementById('strokeColor').addEventListener('input', function(e) {
        settings.strokeColor = e.target.value;
        debouncedUpdatePreview();
    });
});

function handleImageUpload(file) {
    if (!file || !file.type.startsWith('image/')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }

    const preview = document.getElementById('imagePreview');
    const url = URL.createObjectURL(file);
    
    preview.onload = function() {
        URL.revokeObjectURL(url);
        setTimeout(updateMemePreview, 100);
    };
    
    preview.src = url;
    preview.style.display = 'block';
    settings.image = file;
    
    showRealTimePreview();
}

function updateMemePreview() {
    if (!settings.image) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }

    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('imagePreview');

    canvas.width = preview.naturalWidth;
    canvas.height = preview.naturalHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

    const fontSize = Math.max(settings.fontSize, canvas.width / 50);
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const strokeWidth = Math.max(2, fontSize / 10);

    function drawText(text, xPercent, yPercent) {
        if (!text) return;

        const x = (canvas.width * xPercent) / 100;
        const y = (canvas.height * yPercent) / 100;

        ctx.strokeStyle = settings.strokeColor;
        ctx.lineWidth = strokeWidth;
        ctx.strokeText(text, x, y);

        ctx.fillStyle = settings.textColor;
        ctx.fillText(text, x, y);
    }

    drawText(settings.textTop, settings.textTopX, settings.textTopY);

    drawText(settings.textBottom, settings.textBottomX, settings.textBottomY);

    canvas.style.display = 'block';
    document.getElementById('downloadSection').style.display = 'block';

    const dataUrl = canvas.toDataURL('image/jpeg');
    document.getElementById('downloadLink').href = dataUrl;

    showRealTimePreview();
}

function downloadMeme() {
    if (!settings.image) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }
    updateMemePreview();
    document.getElementById('downloadLink').click();
}

function clearAll() {
    settings.image = null;
    settings.textTop = '';
    settings.textBottom = '';
    
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('memeCanvas').style.display = 'none';
    document.getElementById('downloadSection').style.display = 'none';
    document.getElementById('textTop').value = '';
    document.getElementById('textBottom').value = '';
    document.getElementById('realTimePreview').style.display = 'none';
    
    document.getElementById('textTopX').value = 50;
    document.getElementById('textTopY').value = 20;
    document.getElementById('textBottomX').value = 50;
    document.getElementById('textBottomY').value = 80;
    document.getElementById('fontSize').value = 30;
    document.getElementById('textColor').value = '#ffffff';
    document.getElementById('strokeColor').value = '#000000';
}

let updateTimeout;
function debouncedUpdatePreview() {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(updateMemePreview, 300);
    showRealTimePreview();
}

function showRealTimePreview() {
    const preview = document.getElementById('realTimePreview');
    preview.style.display = 'block';
    setTimeout(() => {
        preview.style.display = 'none';
    }, 2000);
}

window.addEventListener('load', function() {
    const savedData = localStorage.getItem('memeSettings');
    if (savedData) {
        const savedSettings = JSON.parse(savedData);
        Object.assign(settings, savedSettings);
        
        document.getElementById('textTop').value = settings.textTop || '';
        document.getElementById('textBottom').value = settings.textBottom || '';
        document.getElementById('textTopX').value = settings.textTopX || 50;
        document.getElementById('textTopY').value = settings.textTopY || 20;
        document.getElementById('textBottomX').value = settings.textBottomX || 50;
        document.getElementById('textBottomY').value = settings.textBottomY || 80;
        document.getElementById('fontSize').value = settings.fontSize || 30;
        document.getElementById('textColor').value = settings.textColor || '#ffffff';
        document.getElementById('strokeColor').value = settings.strokeColor || '#000000';
        
        if (settings.image) {
            setTimeout(updateMemePreview, 500);
        }
    }
});

window.addEventListener('beforeunload', function() {
    localStorage.setItem('memeSettings', JSON.stringify(settings));
});
</script>
     <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
            .then(registration => {
                console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
            })
            .catch(error => {
                console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', error);
            });
        });
        }
    </script>
</body>
</html>